<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapports Audits - GIRASOLE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .rapport-card { 
            transition: all 0.3s; 
            cursor: pointer;
        }
        .rapport-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); 
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-6 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">
                        <i class="fas fa-file-pdf mr-3"></i>
                        Rapports Audits GIRASOLE
                    </h1>
                    <p class="text-blue-100 mt-2" id="subheader">
                        <i class="fas fa-building mr-2"></i>
                        Chargement...
                    </p>
                </div>
                <div>
                    <a href="/" class="bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold hover:bg-blue-50 transition">
                        <i class="fas fa-home mr-2"></i>Accueil
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Contenu principal -->
    <main class="container mx-auto px-6 py-8">
        
        <!-- Stats rapides -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="statsContainer">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="bg-green-100 p-3 rounded-lg">
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Rapports termin√©s</p>
                        <p class="text-2xl font-bold text-gray-800" id="stat-termines">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <i class="fas fa-clipboard-list text-blue-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">En cours</p>
                        <p class="text-2xl font-bold text-gray-800" id="stat-encours">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="bg-orange-100 p-3 rounded-lg">
                        <i class="fas fa-exclamation-triangle text-orange-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Non-conformit√©s</p>
                        <p class="text-2xl font-bold text-gray-800" id="stat-nonconformes">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="bg-purple-100 p-3 rounded-lg">
                        <i class="fas fa-solar-panel text-purple-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Audits toiture</p>
                        <p class="text-2xl font-bold text-gray-800" id="stat-toiture">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste des rapports -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-list mr-2"></i>
                Tous les rapports
            </h2>
            
            <div class="space-y-4" id="rapportsContainer">
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Chargement des rapports...</p>
                </div>
            </div>
        </div>
        
    </main>

    <script>
        async function loadRapports() {
            try {
                const response = await fetch('/api/rapports')
                const result = await response.json()
                
                if (!result.success) {
                    throw new Error(result.error)
                }
                
                const rapports = result.data
                
                // Update subheader
                document.getElementById('subheader').innerHTML = `<i class="fas fa-building mr-2"></i>${rapports.length} rapport(s) disponible(s)`
                
                // Update stats
                const termines = rapports.filter(r => r.statut === 'TERMINE' || r.statut === 'VALIDE').length
                const encours = rapports.filter(r => r.statut === 'EN_COURS').length
                const nonconformes = rapports.reduce((sum, r) => sum + (r.nb_items_non_conformes || 0), 0)
                const toiture = rapports.filter(r => r.type_rapport === 'AUDIT_COMPLET').length
                
                document.getElementById('stat-termines').textContent = termines
                document.getElementById('stat-encours').textContent = encours
                document.getElementById('stat-nonconformes').textContent = nonconformes
                document.getElementById('stat-toiture').textContent = toiture
                
                // Display rapports list
                const container = document.getElementById('rapportsContainer')
                
                if (rapports.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Aucun rapport disponible</p>
                            <p class="text-sm text-gray-400 mt-2">Les rapports appara√Ætront ici apr√®s g√©n√©ration</p>
                        </div>
                    `
                    return
                }
                
                container.innerHTML = rapports.map(r => {
                    const borderColor = r.statut === 'VALIDE' ? 'border-green-500' :
                                      r.statut === 'TERMINE' ? 'border-blue-500' :
                                      r.statut === 'EN_COURS' ? 'border-orange-500' : 'border-gray-300'
                    
                    const badgeColor = r.statut === 'VALIDE' ? 'bg-green-100 text-green-700' :
                                     r.statut === 'TERMINE' ? 'bg-blue-100 text-blue-700' :
                                     r.statut === 'EN_COURS' ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-700'
                    
                    const badgeText = r.statut === 'VALIDE' ? '‚úÖ Valid√©' :
                                    r.statut === 'TERMINE' ? 'üìÑ Termin√©' :
                                    r.statut === 'EN_COURS' ? '‚è≥ En cours' : 'üìù Brouillon'
                    
                    const dateStr = new Date(r.date_audit).toLocaleDateString('fr-FR')
                    
                    return `
                        <div class="rapport-card bg-gray-50 rounded-lg p-5 border-l-4 ${borderColor}" onclick="alert('Voir rapport ${r.id} - TODO: page d√©tail')">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <h3 class="text-lg font-bold text-gray-800">${r.centrale_nom}</h3>
                                        <span class="badge ${badgeColor}">${badgeText}</span>
                                        ${r.type_rapport === 'AUDIT_COMPLET' ? '<span class="badge bg-purple-100 text-purple-700">üè† Toiture</span>' : ''}
                                    </div>
                                    
                                    <div class="flex items-center space-x-6 text-sm text-gray-600 mb-3">
                                        <span><i class="fas fa-bolt text-yellow-600 mr-1"></i>${r.puissance_kwc} kWc</span>
                                        <span><i class="fas fa-calendar text-blue-600 mr-1"></i>${dateStr}</span>
                                        <span><i class="fas fa-user text-gray-600 mr-1"></i>${r.auditeur}</span>
                                    </div>
                                    
                                    <div class="flex items-center space-x-4 text-sm">
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                                            <span class="text-gray-700">${r.nb_items_conformes || 0} conformes</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                                            <span class="text-gray-700">${r.nb_items_non_conformes || 0} non-conformes</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 rounded-full bg-gray-400 mr-2"></div>
                                            <span class="text-gray-700">${r.nb_items_na || 0} N/A</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                }).join('')
                
            } catch (error) {
                console.error('Erreur chargement rapports:', error)
                document.getElementById('rapportsContainer').innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-6">
                        <p class="text-red-700"><strong>Erreur:</strong> ${error.message}</p>
                    </div>
                `
            }
        }
        
        // Load rapports on page load
        document.addEventListener('DOMContentLoaded', loadRapports)
    </script>
</body>
</html>
